<?php
//*****************************************************************************
//*****************************************************************************
/**
 * WS2812 Node Core Trait
 *
 * @package         Cclark61\RPi\WS2812
 * @subpackage      Traits
 * @author          Christian J. Clark
 * @copyright       Christian J. Clark
 * @link            https://github.com/cclark61/php-rpi-ws2812
 **/
//*****************************************************************************
//*****************************************************************************

namespace Cclark61\RPi\WS2812\Traits;

trait Core
{
    //=========================================================================
    // Class Members
    //=========================================================================
    protected $config = false;
    protected $buffering = false;
    protected $buffer = false;
    protected $node_socket = false;
    protected $gpionum = false;
    protected $chip_type = false;
    protected $channel = false;
    protected $led_count = false;

    //=========================================================================
    //=========================================================================
    // Constructor
    //=========================================================================
    //=========================================================================
    public function __construct($args='default')
    {
        //---------------------------------------------------------------------
        // Get Configuration
        //---------------------------------------------------------------------
        $this->config = \Cclark61\RPi\WS2812\Config\Node::GetConfig($args);
        if (!$this->config) {
            die("[!!] Invalid node configurarion.\n");
        }

        //---------------------------------------------------------------------
        // Initiate Node
        //---------------------------------------------------------------------
        $this->InitiateNode($this->config);
    }

    //=========================================================================
    //=========================================================================
    // Destructor
    //=========================================================================
    //=========================================================================
    public function __destruct()
    {
        //---------------------------------------------------------------------
        // Turn Off LEDs
        //---------------------------------------------------------------------
        $this->ClearNode();

        //---------------------------------------------------------------------
        // Close Socket
        //---------------------------------------------------------------------
        if ($this->node_socket) {
            fclose($this->node_socket);
        }
    }

    //=========================================================================
    //=========================================================================
    // Node Is Valid?
    //=========================================================================
    //=========================================================================
    public function IsValid()
    {
        return ($this->config && $this->node_socket && $this->led_count);
    }

    //=========================================================================
    //=========================================================================
    // Clear Node (Turn Off)
    //=========================================================================
    //=========================================================================
    public function ClearNode()
    {
        $this->Reset();
        $data = "reset;setup {$this->channel},{$this->led_count};init;fill 1,000000;render;";
        $this->WriteCommand($data);
    }

    //=========================================================================
    //=========================================================================
    // Set Channel
    //=========================================================================
    //=========================================================================
    public function SetChannel(Integer $channel)
    {
        $this->channel = $channel;
    }

    //=========================================================================
    //=========================================================================
    // Set Number LEDS
    //=========================================================================
    //=========================================================================
    public function SetLEDCount(Integer $led_count)
    {
        $this->led_count = $led_count;
    }

    //=========================================================================
    //=========================================================================
    // Set Buffering
    //=========================================================================
    //=========================================================================
    public function SetBuffering($buffering)
    {
        $this->buffering = (bool)$buffering;
    }

    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    // Setup / Initialization Command Methods
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    //=========================================================================
    //=========================================================================
    // Reset
    //=========================================================================
    //=========================================================================
    public function Reset()
    {
        $this->WriteCommand('reset;');
    }

    //=========================================================================
    //=========================================================================
    // Setup
    //=========================================================================
    //=========================================================================
    public function Setup(Array $args=[])
    {
        $channel = $this->channel;
        $led_count = $this->led_count;
        $invert = 0;
        $global_brightness = 255;
        $led_type = 3;
        $gpionum = $this->gpionum;
        extract($args);

        //---------------------------------------------------------------------
        // WS2812
        //---------------------------------------------------------------------
        if ($this->chip_type == 'ws2812' || $this->chip_type == 'sk6812') {
            $cmd = "setup {$channel},{$led_count},{$led_type},{$invert},{$global_brightness},{$gpionum};";
            $this->WriteCommand($cmd);
            return true;
        }
        //---------------------------------------------------------------------
        // SK9822
        //---------------------------------------------------------------------
        else if ($this->chip_type == 'sk9822') {
            // To Do...
        }

        //---------------------------------------------------------------------
        // Setup Failed
        //---------------------------------------------------------------------
        return false;
    }

    //=========================================================================
    //=========================================================================
    // Init
    //=========================================================================
    //=========================================================================
    public function Init()
    {
        $this->WriteCommand('init;');
    }

    //=========================================================================
    //=========================================================================
    // Render
    //=========================================================================
    //=========================================================================
    public function Render(Array $args=[])
    {
        $delay = 0;
        $write_buffer = true;
        extract($args);
        $cmd = 'render;';
        if ($delay) {
            $cmd = "delay {$delay};{$cmd}";
        }
        $this->WriteCommand($cmd, $write_buffer);
    }

    //=========================================================================
    //=========================================================================
    // Delay
    //=========================================================================
    //=========================================================================
    public function Delay($delay)
    {
        $this->WriteCommand("delay {$delay};");
    }

    //=========================================================================
    //=========================================================================
    // Reset, Setup, Initialize Method
    //=========================================================================
    //=========================================================================
    public function RSI(Array $args=[])
    {
        $this->Reset($args);
        $this->Setup($args);
        $this->Init($args);
    }

    //=========================================================================
    //=========================================================================
    // Write Command
    //=========================================================================
    //=========================================================================
    public function WriteCommand(String $cmd, $write_buffer=false)
    {
        if ($write_buffer || !$this->buffer) {
            if ($this->buffer) {
                if (substr($this->buffer, strlen($this->buffer) - 1, 1) != ';') {
                    $this->buffer .= ';';
                }
                $cmd = $this->buffer . $cmd;
                $this->buffer = false;
            }
            return fwrite($this->node_socket, $cmd);
        }
        return true;
    }

    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    // Internal Methods
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    //%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    //=========================================================================
    //=========================================================================
    // Initiate Node
    //=========================================================================
    //=========================================================================
    protected function InitiateNode(Array $config)
    {
        //---------------------------------------------------------------------
        // Open Socket to Node
        //---------------------------------------------------------------------
        $sock = fsockopen($config['host'], $config['port']);
        if (!$sock) {
            die("[!!] Failed to open remote connection to node.\n");
        }
        $this->node_socket = $sock;

        //---------------------------------------------------------------------
        // Set class values from config
        //---------------------------------------------------------------------
        $this->gpionum = $config['gpionum'];
        $this->chip_type = $config['chip_type'];
        $this->channel = $config['channel'];
        $this->led_count = $config['led_count'];
        if (isset($config['buffering'])) {
            $this->buffering = $config['buffering'];
        }
        else {
            $this->buffering = false;
        }

        //---------------------------------------------------------------------
        // Reset, Setup, and Init Hardware
        //---------------------------------------------------------------------
        $this->RSI();

        //---------------------------------------------------------------------
        // Return Success
        //---------------------------------------------------------------------
        return true;
    }

}
