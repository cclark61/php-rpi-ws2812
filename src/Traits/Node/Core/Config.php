<?php
//*****************************************************************************
//*****************************************************************************
/**
 * WS2812 Node Core Config Trait
 *
 * @package         Cclark61\RPi\WS2812
 * @subpackage      Traits\Node\Core
 * @author          Christian J. Clark
 * @copyright       Christian J. Clark
 * @link            https://github.com/cclark61/php-rpi-ws2812
 **/
//*****************************************************************************
//*****************************************************************************

namespace Cclark61\RPi\WS2812\Traits\Node\Core;

trait Config
{
    //=========================================================================
    // Class Members
    //=========================================================================
    protected $config = false;

    //=========================================================================
    //=========================================================================
    // Get Config
    //=========================================================================
    //=========================================================================
    public static function GetNodeConfig($args)
    {
        //---------------------------------------------------------------------
        // App Config
        //---------------------------------------------------------------------
        $app_config = new \phpOpenFW\Core\AppConfig();

        //---------------------------------------------------------------------
        // Config Empty? Is there Default one specified?
        //---------------------------------------------------------------------
        if (!$args) {
            $node_configs = $app_config['nodes'];
            if (!empty($node_configs)) {
                $args = key($node_configs);
            }
            else {
                return static::DefaultNodeConfig();                
            }
        }

        //---------------------------------------------------------------------
        // Config is an array
        //---------------------------------------------------------------------
        if (is_array($args)) {
            $config = static::ValidateNodeConfig(static::DefaultNodeConfig($args));
        }
        //---------------------------------------------------------------------
        // Config index given
        //---------------------------------------------------------------------
        else {
            $index = $args;
            if (empty($app_config->nodes[$index])) {
                if ($index == 'default') {
                    return static::DefaultNodeConfig();
                }
                else {
                    die("[!!] Invalid configuration index.\n");
                }
            }
            $config = static::ValidateNodeConfig(static::DefaultNodeConfig($app_config->nodes[$index]));
        }

        //---------------------------------------------------------------------
        // Config Transformations
        //---------------------------------------------------------------------
        $config['chip_type'] = strtolower($config['chip_type']);

        //---------------------------------------------------------------------
        // Return Config
        //---------------------------------------------------------------------
        return $config;
    }

    //=========================================================================
    //=========================================================================
    // Validate Config
    //=========================================================================
    //=========================================================================
    public static function ValidateNodeConfig(Array $args)
    {
        //---------------------------------------------------------------------
        // Check that config is an array
        //---------------------------------------------------------------------
        if (!is_array($args)) {
            die("[!!] Node configuration must be an array.\n");
        }
        $config = $args;

        //---------------------------------------------------------------------
        // GPIO Pin Number
        //---------------------------------------------------------------------
        if (empty($config['gpionum'])) {
            die("[!!] Node GPIO pin number (gpionum) not specified.\n");
        }

        //---------------------------------------------------------------------
        // Check Chip Type
        //---------------------------------------------------------------------
        $valid_chip_types = ['ws2812', 'sk6812', 'sk9822'];
        if (empty($config['chip_type'])) {
            die("[!!] Node chip type (chip_type) not specified.\n");
        }
        else if (!in_array($config['chip_type'], $valid_chip_types)) {
            $str_valid_chips = implode(', ' , $valid_chip_types);
            die("[!!] Invalid node chip type specified. Valid values are: {$str_valid_chips}.\n");
        }

        //---------------------------------------------------------------------
        // Check Host
        //---------------------------------------------------------------------
        if (empty($config['host'])) {
            die("[!!] Node host (host) not specified.\n");
        }

        //---------------------------------------------------------------------
        // Check Port
        //---------------------------------------------------------------------
        if (empty($config['port'])) {
            die("[!!] Node port (port) not specified.\n");
        }

        //---------------------------------------------------------------------
        // Check Channel
        //---------------------------------------------------------------------
        if (empty($config['channel'])) {
            die("[!!] Node channel (channel) not specified.\n");
        }

        //---------------------------------------------------------------------
        // Check number of LEDs
        //---------------------------------------------------------------------
        if (empty($config['led_count'])) {
            die("[!!] Number of LEDs (led_count) in the node was not specified.\n");
        }

        //---------------------------------------------------------------------
        // Return Config
        //---------------------------------------------------------------------
        return $config;
    }

    //=========================================================================
    //=========================================================================
    // Default Node Config
    //=========================================================================
    //=========================================================================
    public static function DefaultNodeConfig(Array $args=[])
    {
        //---------------------------------------------------------------------
        // Set Default Config
        //---------------------------------------------------------------------
        $config = [
            'index' => 'default',
            'gpionum' => 18,
            'chip_type' => 'ws2812',
            'channel' => 1,
            'host' => '127.0.0.1',
            'port' => 9999,
            'led_count' => 10
        ];

        //---------------------------------------------------------------------
        // Override Config Values?
        //---------------------------------------------------------------------
        if ($args) {
            $config = array_merge($config, $args);
        }

        //---------------------------------------------------------------------
        // Return Config
        //---------------------------------------------------------------------
        return $config;
    }

}
